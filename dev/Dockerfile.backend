# syntax=docker/dockerfile:1.4
FROM python:3.10-slim

# Install system dependencies including ffmpeg for video clip export
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Install Poetry
RUN pip install --no-cache-dir poetry==1.7.1
ENV PATH="/root/.local/bin:$PATH"

# Disable virtualenv creation
RUN poetry config virtualenvs.create false

WORKDIR /app

# Copy Poetry files for dependency caching
COPY backend/pyproject.toml backend/poetry.lock* ./

# Install dependencies
RUN poetry install --no-root

# Copy application code and other necessary files
# The docker-compose.yml already mounts the src, alembic, etc. so these COPYs are for when not using compose volumes
COPY backend/src ./src
COPY backend/alembic ./alembic
COPY backend/alembic.ini ./
COPY backend/gunicorn.conf.py ./
COPY backend/scripts ./scripts

EXPOSE 8000

# The command is defined in docker-compose.yml